pipeline {
    agent {
        label 'harness-1'
    }
    
    environment {
        APP_NAME = 'java-app-1'
        IMAGE_NAME = "${APP_NAME}:${BUILD_NUMBER}"
        KUBERNETES_NAMESPACE = 'java-app-1'
        DOCKER_REGISTRY = 'localhost:5000' // Set your Docker registry URL if needed
        // Uncomment and configure if Java 17 is configured as a Jenkins tool:
        // JAVA_HOME = tool 'JDK-17'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                sh '''
                    echo "Checkout completed in: $(pwd)"
                    ls -la
                '''
            }
        }
        
        stage('Build') {
            steps {
                dir('jenkins/java-app-1') {
                    echo 'Building Java application with Maven...'
                    script {
                        sh '''
                            echo "Current directory: $(pwd)"
                            echo "Checking for pom.xml..."
                            if [ ! -f pom.xml ]; then
                                echo "ERROR: pom.xml not found in jenkins/java-app-1"
                                ls -la
                                exit 1
                            fi
                            echo "✓ pom.xml found"
                            
                            # Check Java version and set JAVA_HOME
                            echo "Checking Java version..."
                            
                            # Find Java executable
                            JAVA_PATH=$(which java 2>/dev/null || readlink -f $(which java 2>/dev/null) || echo "")
                            
                            if [ -z "$JAVA_PATH" ]; then
                                echo "ERROR: Java not found in PATH"
                                exit 1
                            fi
                            
                            # Determine JAVA_HOME from java executable path
                            # Handle both /usr/bin/java -> /usr/lib/jvm/java-21-openjdk-amd64/bin/java and direct paths
                            if [ -L "$JAVA_PATH" ]; then
                                JAVA_PATH=$(readlink -f "$JAVA_PATH")
                            fi
                            
                            # Extract JAVA_HOME (go up two levels from bin/java)
                            JAVA_HOME=$(dirname $(dirname "$JAVA_PATH"))
                            
                            # Verify JAVA_HOME is valid
                            if [ ! -d "$JAVA_HOME" ] || [ ! -f "$JAVA_HOME/bin/javac" ]; then
                                echo "WARNING: Could not determine valid JAVA_HOME from $JAVA_PATH"
                                # Try common locations
                                for jhome in "/usr/lib/jvm/java-21-openjdk-amd64" "/usr/lib/jvm/java-21" "/usr/lib/jvm/java-17-openjdk-amd64" "/usr/lib/jvm/java-17"; do
                                    if [ -d "$jhome" ] && [ -f "$jhome/bin/javac" ]; then
                                        JAVA_HOME="$jhome"
                                        break
                                    fi
                                done
                            fi
                            
                            # Export JAVA_HOME and update PATH
                            export JAVA_HOME
                            export PATH="$JAVA_HOME/bin:$PATH"
                            
                            echo "JAVA_HOME set to: $JAVA_HOME"
                            
                            # Verify Java version
                            JAVA_VERSION=$(java -version 2>&1 | head -n 1)
                            echo "Java version: $JAVA_VERSION"
                            
                            # Check if Java 17+ is available
                            JAVA_MAJOR=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1)
                            if [ -z "$JAVA_MAJOR" ]; then
                                echo "ERROR: Could not determine Java version"
                                exit 1
                            fi
                            
                            if [ "$JAVA_MAJOR" -lt 17 ]; then
                                echo "ERROR: Java 17 or higher is required. Found Java version: $JAVA_MAJOR"
                                echo "Please install Java 17+ on the Jenkins node or configure JAVA_HOME"
                                exit 1
                            fi
                            
                            echo "✓ Java $JAVA_MAJOR detected (17+ required)"
                            
                            # Verify Maven will use the correct Java
                            echo "Verifying Maven Java configuration..."
                            mvn -version
                            
                            echo "Proceeding with build..."
                            mvn clean package -DskipTests
                        '''
                    }
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'jenkins/java-app-1/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Test') {
            steps {
                dir('jenkins/java-app-1') {
                    echo 'Running tests...'
                    script {
                        sh '''
                            # Set JAVA_HOME if not already set
                            if [ -z "$JAVA_HOME" ] || [ "$JAVA_HOME" = "" ]; then
                                JAVA_PATH=$(which java 2>/dev/null || readlink -f $(which java 2>/dev/null) || echo "")
                                if [ -n "$JAVA_PATH" ]; then
                                    if [ -L "$JAVA_PATH" ]; then
                                        JAVA_PATH=$(readlink -f "$JAVA_PATH")
                                    fi
                                    JAVA_HOME=$(dirname $(dirname "$JAVA_PATH"))
                                    export JAVA_HOME
                                    export PATH="$JAVA_HOME/bin:$PATH"
                                fi
                            else
                                export PATH="$JAVA_HOME/bin:$PATH"
                            fi
                            mvn test
                        '''
                    }
                }
            }
            post {
                always {
                    script {
                        def testResultsDir = 'jenkins/java-app-1/target/surefire-reports'
                        def testResults = sh(
                            script: "find ${testResultsDir} -name '*.xml' 2>/dev/null | wc -l",
                            returnStdout: true
                        ).trim()
                        if (testResults.toInteger() > 0) {
                            echo "Found ${testResults} test result file(s), publishing..."
                            junit 'jenkins/java-app-1/target/surefire-reports/*.xml'
                        } else {
                            echo "No test results found, skipping junit step"
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('jenkins/java-app-1') {
                    echo "Building Docker image: ${IMAGE_NAME}"
                    script {
                        sh """
                            docker build -t ${IMAGE_NAME} .
                        """
                        sh """
                            docker tag ${IMAGE_NAME} ${DOCKER_REGISTRY}/${IMAGE_NAME}
                            docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                dir('jenkins/java-app-1') {
                    echo "Deploying ${APP_NAME} to Kubernetes namespace: ${KUBERNETES_NAMESPACE}"
                    script {
                        // Update deployment with new image
                        sh """
                            sed -i.bak 's|image: ${APP_NAME}:.*|image: ${DOCKER_REGISTRY}/${IMAGE_NAME}|g' k8s/deployment.yaml
                            kubectl apply -f k8s/deployment.yaml -n ${KUBERNETES_NAMESPACE}
                            kubectl apply -f k8s/service.yaml -n ${KUBERNETES_NAMESPACE}
                        """
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'Verifying deployment...'
                script {
                    sh """
                        kubectl rollout status deployment/${APP_NAME} -n ${KUBERNETES_NAMESPACE} --timeout=300s
                        kubectl get pods -l app=${APP_NAME} -n ${KUBERNETES_NAMESPACE}
                        kubectl get svc ${APP_NAME}-service -n ${KUBERNETES_NAMESPACE}
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
            echo "Application deployed: ${APP_NAME}"
            echo "Image: ${IMAGE_NAME}"
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
